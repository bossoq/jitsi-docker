#!/bin/bash

COMMAND="/usr/local/bin/ffmpeg-original"
GENARG=" -y -v info -vaapi_device /dev/dri/renderD129 -f x11grab -draw_mouse 0 -r 30 -s 1920x1080 -thread_queue_size 8192 -probesize 100M -i :0.0+0,0 -f pulse -thread_queue_size 8192 -i default -acodec libfdk_aac -strict -2 -ar 44100 -vf "
GENARG2=" -c:v h264_vaapi -qp:v 19 -bf 4 -threads 4 -aspect 16:9 "

FFARGUR=" -f mp4 "

T="${!#}"

_int() {
	kill -INT "$PID" 2>/dev/null
}

trap _int SIGINT

echo "Replacing command to >>: ${COMMAND} ${GENARG} 'format=nv12,hwupload,scale_vaapi=w=1920:h=1080' ${GENARG2} ${USEARGS} ${T}." >> /opt/util/logs
exec ${COMMAND} ${GENARG} 'format=nv12,hwupload,scale_vaapi=w=1920:h=1080' ${GENARG2} ${USEARGS} ${T}
PID=$!

echo "Wait for process complete: $PID."
wait $PID